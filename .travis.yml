language: node_js
node_js:
- 7.10.1
env:
  global:
  - RELEASE_BRANCH=release
  - BRANCH=${TRAVIS_PULL_REQUEST_BRANCH:-$TRAVIS_BRANCH}
  - ENCRYPTION_LABEL=c8bf86153df9
before_install:
# Decrypt travis secret for ssh private key
- ENCRYPTED_KEY_VAR="encrypted_${ENCRYPTION_LABEL}_key"
- ENCRYPTED_IV_VAR="encrypted_${ENCRYPTION_LABEL}_iv"
- ENCRYPTED_KEY=${!ENCRYPTED_KEY_VAR}
- ENCRYPTED_IV=${!ENCRYPTED_IV_VAR}
- mkdir -p ~/.ssh
- openssl aes-256-cbc -K $ENCRYPTED_KEY -iv $ENCRYPTED_IV
  -in sudomesh-travis-ci.enc -out ~/.ssh/sudomesh-travis-ci -d
- chmod 600 ~/.ssh/sudomesh-travis-ci
- eval $(ssh-agent -s)
- ssh-add ~/.ssh/sudomesh-travis-ci

after_success:
- REPO=`git config remote.origin.url`
- echo "REPO=$REPO"
- |
  if [ "$BRANCH" = "$RELEASE_BRANCH" ]; then
    git config --local user.name "Travis CI"
    git config --local user.email "travis-ci@sudomesh.org"
    NODE_PACKAGE_VERSION=$(cat package.json | jq -r .version)
    git tag -a "$NODE_PACKAGE_VERSION" -m "$NODE_PACKAGE_VERSION"
    SSH_REPO=${REPO/https:\/\/github.com\//git@github.com:}
    git remote add release_repo "$SSH_REPO"
    git push release_repo "$NODE_PACKAGE_VERSION"
  fi
